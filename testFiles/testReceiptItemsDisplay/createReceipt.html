<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Receipt</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.5/sweetalert2.all.js"
      integrity="sha512-AINSNy+d2WG9ts1uJvi8LZS42S8DT52ceWey5shLQ9ArCmIFVi84nXNrvWyJ6bJ+qIb1MnXR46+A4ic/AUcizQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.5/sweetalert2.css"
      integrity="sha512-yqCpLPABHnpDe3/QgEm1OO4Ohq0BBlBtJGMh5JbhdYEb6nahIm7sbtjilfSFyzUhxdXHS/cm8+FYfNstfpxcrg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!--<script
      type="text/javascript"
      src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"
    ></script>-->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"
      integrity="sha512-fD9DI5bZwQxOi7MhYWnnNPlvXdp/2Pj3XSTRrFs5FQa4mizyGLnJcN6tuvUS6LbmgN1ut+XGSABKvjN0H6Aoow=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css"
      rel="stylesheet"
    />
  </head>
  <style>
    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      align-items: center;
    }
    .itemDiv {
      display: flex;
      justify-content: space-around;
    }
    .quantity {
      width: 100px;
    }
    .subtotal,
    .unitprice,
    .total {
      width: 100px;
    }
    .addItem {
      background: transparent;
      border: none;
      cursor: pointer;
    }

    #receiptBtn {
      background: transparent;
      border: none;
      cursor: pointer;
    }
    :hover.addItem {
      box-shadow: 0 4px 15px 0 rgba(45, 54, 65, 0.75);
      box-sizing: unset;
    }
    #uploadedImage {
      width: 150px;
    }
  </style>
  <body>
    <div class="header">
      <div class="itemNameHeader">Items</div>
      <div class="quantityHeader">Quantity</div>
      <div class="unitPriceHeader">
        <i class="fa-solid fa-dollar-sign" style="color: #43add0"></i>Unit Price
      </div>
      <div class="subTotalHeader">
        <i class="fa-solid fa-dollar-sign" style="color: #43add0"></i>Subtotal
      </div>
      <div class="deleteHeader">Delete</div>
    </div>
    <div id="templateList"></div>
    <div class="totalFooter">
      Total<input type="text" class="total" disabled />
    </div>
    <button class="addItem"><i class="fa-solid fa-circle-plus"></i></button>
    <button id="receiptBtn">
      <i class="fa-solid fa-receipt" style="color: #14d7b0"></i>
    </button>
    <br />
    <div>
      <label for="attachment">Uploaded Receipt</label>
    </div>
    <div id="viewImage"></div>

    <template id="itemList">
      <div class="itemDiv">
        <input type="text" class="itemName" />
        <input type="text" class="quantity" />
        <input type="text" class="unitprice" />
        <input type="text" class="subtotal" />
        <input type="button" value="Delete" class="deleteBtn" />
      </div>
    </template>
  </body>
  <script>
    const imagepath = JSON.parse(localStorage.getItem("imagepath"));
    window.addEventListener("load", async () => {
      let viewImageDiv = document.querySelector("#viewImage");

      let element;
      element = document.createElement("img");
      element.setAttribute("id", "uploadedImage");
      element.setAttribute("src", imagepath);
      element.addEventListener("click", () => {
        Swal.fire({
          imageUrl: element.src,
          showCloseButton: true,
          showConfirmButton: false,
          imageWidth: 500,
        });
      });
      viewImageDiv.appendChild(element);
    });

    //const data = JSON.parse(localStorage.getItem("itemData")); using localstorage

    //const res = await fetch("/loadReceiptItems",{
    // method:"GET",
    // headers:{"Content-Type": "application/json"}
    //})
    //
    //const result = await res.json();
    //const itemList = result.itemList
    //const data = itemList
    const data = [
      [["麻辣牛肉并"], ["$76.00"]],
      [["旦式咖喱煎"], ["$93.00"]],
      [["滑蛋汁燒鰻"], ["$94.00"]],
      [["1x 七味牛肉#"], ["$76.00"]],
      [["小計", "增值稅"], ["$585.00"]],
      [["增值稅"], ["$5.00"]],
      [["外虱自取盯單"], ["-$292.50"]],
      [["總計", "雖扒蛋蓋飯", "魚并"], ["$297.50"]],
    ];

    let receiptBtn = document.querySelector("#receiptBtn");
    receiptBtn.addEventListener("click", () => {
      window.location.href = "./addPeopleList.html";
    });
    const itemListTemplate = document.querySelector("#itemList");
    const templateList = document.querySelector("#templateList");
    function itemClone(data = [[""], ["$0.00"]], id) {
      let node = itemListTemplate.content.cloneNode(true);
      const deleteBtn = node.querySelector(".deleteBtn");
      let itemDiv = node.querySelector(".itemDiv");
      itemDiv.setAttribute("id", `item${id}`);

      let itemName = data[0].join();

      while (itemName.indexOf(",") != -1) {
        itemName = itemName.replace(",", " ");
      }
      node.querySelector(".itemName").value = itemName;

      let quantityInput = node.querySelector(".quantity");
      let unitpriceInput = node.querySelector(".unitprice");
      let subtotalInput = node.querySelector(".subtotal");

      quantityInput.value = 1;

      subtotalInput.value = data[1][0].replace("$", "");

      unitpriceInput.value = subtotalInput.value / quantityInput.value;
      unitpriceInput.readOnly = true;
      quantityInput.addEventListener("input", () => {
        let quantity = parseFloat(quantityInput.value);
        let subtotal = parseFloat(subtotalInput.value);
        let unitprice = quantity === 0 ? 0 : subtotal / quantity;
        unitpriceInput.value = `${unitprice.toFixed(2)}`;

        updateTotal();
      });

      subtotalInput.addEventListener("input", () => {
        let quantity = parseFloat(quantityInput.value);
        let subtotal = parseFloat(subtotalInput.value);
        let unitprice = quantity === 0 ? 0 : subtotal / quantity;
        unitpriceInput.value = `${unitprice.toFixed(2)}`;

        updateTotal();
      });

      deleteBtn.addEventListener("click", () => {
        document.getElementById(`item${id}`).remove();
        updateTotal();
      });

      templateList.appendChild(node);
      updateTotal();
    }

    function updateTotal() {
      let subtotalList = document.querySelectorAll(".subtotal");
      let totalInput = document.querySelector(".total");

      let subtotal = 0;

      for (let i = 0; i < subtotalList.length; i++) {
        subtotal += parseFloat(subtotalList[i].value);
      }

      totalInput.value = `$${subtotal.toFixed(2)}`;
    }

    window.addEventListener("load", () => {
      for (let i = 0; i < data.length; i++) {
        itemClone(data[i], i.toString());
      }
    });

    let addItem = document.querySelector(".addItem");
    addItem.addEventListener("click", () => {
      itemClone();
    });
  </script>
</html>
